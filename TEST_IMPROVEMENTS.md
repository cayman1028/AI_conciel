# テストカバレッジ向上計画

## 現状（2025年03月14日）

現在のテストカバレッジは約20%で、目標の70%には達していません。

- **ステートメントカバレッジ**: 21.57%（目標: 70%）
- **ブランチカバレッジ**: 10.22%（目標: 70%）
- **関数カバレッジ**: 23.78%（目標: 70%）
- **行カバレッジ**: 20.22%（目標: 70%）

## 主な課題

1. **MSWの問題**
   - `BroadcastChannel`のモックが必要
   - NextRequestとNextResponseのモック問題

2. **userContextのテスト問題**
   - メモリキャッシュと`localStorage`の同期問題
   - テスト間の状態の漏洩

3. **ChatWidgetのテスト問題**
   - 複雑なコンポーネントのテストがスキップされている
   - UIイベントとストリーミングレスポンスのモック

4. **APIルートのテスト不足**
   - `app/api/chat/route.ts`のカバレッジが0%

## 改善計画

### フェーズ1：基本的なテスト修正（1-2週間）

1. **失敗しているテストの修正**
   - `userContext.test.ts`のメモリキャッシュ問題を解決
   - MSW依存関係の問題を解決

2. **テスト環境の整備**
   - `jest.setup.js`の改善（必要なモックの追加）
   - テストヘルパー関数の作成

### フェーズ2：コア機能の抽象化（2-4週間）

1. **外部依存の抽象化**
   - ストレージサービスの抽象化（localStorage依存の分離）
   - APIクライアントの抽象化（fetch依存の分離）

2. **依存注入の導入**
   - `userContext.ts`に依存注入を導入
   - `companyConfig.ts`に依存注入を導入

### フェーズ3：モジュール分割（3-6週間）

1. **大きなモジュールの分割**
   - `userContext.ts`を複数の小さなモジュールに分割
   - `ChatWidget.tsx`をより小さなコンポーネントに分割

2. **インターフェースの明確化**
   - 各モジュール間の明確なインターフェース定義
   - 型定義の強化

### フェーズ4：テストカバレッジ向上（継続的）

1. **優先順位付けされたテスト追加**
   - APIルートのテスト追加
   - ユーザーコンテキスト機能のテスト強化
   - UIコンポーネントのテスト強化

2. **エッジケースのテスト**
   - エラー処理のテスト
   - 境界値のテスト

## カバレッジ目標

- **3ヶ月後**: 30%
- **6ヶ月後**: 50%
- **12ヶ月後**: 70%

## 実装のポイント

1. **変更の範囲を限定**
   - 一度に1つのモジュールに集中
   - 公開APIは維持しつつ、内部実装を改善

2. **テストファーストアプローチ**
   - リファクタリング前にテストを書く
   - 既存の動作を保証するテストを追加してから構造変更

3. **継続的な統合**
   - 小さな変更を頻繁にマージ
   - 長期間のブランチを避ける

## 進捗状況

### 2025年03月14日（初期状態）
- BroadcastChannelのモックを追加
- userContextのテストを改善（メモリキャッシュのリセット機能）
- ChatWidgetのテストを改善（themeStylesのモック）
- chat.test.tsのNextRequest/NextResponseモックを改善

### 2025年03月14日（フェーズ1の進捗 - 1回目）
- userContext.test.tsのメモリキャッシュ問題を完全に解決
  - recordUserQuestion関数のテストを修正
  - テスト間の状態漏洩を防止するリセット機能を追加
- jest.setup.jsにNextRequestとNextResponseのモックを追加
- APIルートのテストを追加（src/__tests__/api/chatRoute.test.ts）
  - 通常のレスポンスとストリーミングレスポンスのテスト
  - エラーハンドリングのテスト
- テストヘルパー関数を作成（src/__tests__/helpers/testUtils.ts）
  - モックユーザーコンテキスト作成関数
  - モックメッセージ作成関数
  - localStorageモック関数
  - fetchモック関数
  - ストリームレスポンスモック関数

### 2025年03月14日（フェーズ1の進捗 - 2回目）
- ChatWidgetのテストを改善
  - scrollIntoViewメソッドのモックを追加
  - スキップされていたテストを修正
  - テストケースを簡略化して安定性を向上
- APIルートのテストを改善
  - NextRequestとNextResponseのモックを改善
  - OpenAIクライアントのモックを改善（dangerouslyAllowBrowserオプションを追加）

### 2025年03月14日（フェーズ2の進捗 - 1回目）
- ストレージサービスの抽象化を実装
  - `StorageService`インターフェースを作成
  - `LocalStorageService`と`MemoryStorageService`の実装クラスを作成
  - テストを追加（src/__tests__/lib/services/storageService.test.ts）
- APIクライアントの抽象化を実装
  - `ApiClient`インターフェースを作成
  - `FetchApiClient`と`MockApiClient`の実装クラスを作成
  - テストを追加（src/__tests__/lib/services/apiClient.test.ts）
- OpenAIサービスの抽象化を実装
  - `OpenAIService`インターフェースを作成
  - `OpenAIApiService`と`MockOpenAIService`の実装クラスを作成
  - テストを追加（src/__tests__/lib/services/openaiService.test.ts）
  - warmupルートを更新して新しいOpenAIサービスを使用するように変更

### 2025年03月15日（カバレッジ状況更新）

現在のテストカバレッジは以下の通りです：

- **ステートメントカバレッジ**: 41.68%（目標: 70%）
- **ブランチカバレッジ**: 33.98%（目標: 70%）
- **関数カバレッジ**: 39.39%（目標: 70%）
- **ラインカバレッジ**: 41.31%（目標: 70%）

前回の測定から約20%改善しており、進捗が見られます。

## テスト実行状況

- **テストスイート**: 合計13、成功11、失敗2
- **テスト**: 合計105、成功97、失敗7、スキップ1

## 主な問題点

1. **ChatApiHandlerのテスト**:
   - `handleRequest`メソッドが`undefined`として扱われている
   - シングルトンパターンのテストが失敗している

2. **UserContextServiceのテスト**:
   - `resetCache`テストでキャッシュリセット後のテーマ値が期待値と一致しない

## カバレッジが低いファイル

1. **app/api/chat/route.ts**: 0%（特に重要）
2. **lib/companyResponses.ts**: 0%
3. **lib/companyTheme.ts**: 8.39%
4. **lib/companyConfig.ts**: 9.09%

## 優先度の高い改善項目（2025年03月15日更新）

1. **ChatApiHandlerのテスト修正**:
   - モックの実装を見直し、`handleRequest`メソッドが正しく動作するようにする
   - シングルトンパターンのテストを修正する
   - 依存性注入を活用したテスト可能な設計に変更する

2. **UserContextServiceのテスト修正**:
   - `resetCache`テストの期待値と実際の値の不一致を解決する
   - 依存性注入パターンを活用したテストを追加する

3. **APIルートのテスト強化**:
   - リクエスト処理の各ステップをテストする
   - エラー処理とレート制限のテストを追加する
   - ストリーミングレスポンスのテストを改善する

4. **会社設定関連のテスト追加**:
   - `CompanyConfigService`のテストを追加
   - 設定の読み込みと解析のテストを追加
   - キャッシュメカニズムのテストを追加

5. **ChatWidgetコンポーネントのテスト強化**:
   - ユーザー操作のテストを追加
   - エラー状態の処理テストを改善
   - 非同期処理のテストを強化

## 実装計画（更新版）

1. **第1フェーズ**: APIルートとUserContextServiceのテスト修正（優先度最高）
   - 目標カバレッジ: 50%

2. **第2フェーズ**: 会社設定関連のテスト追加
   - 目標カバレッジ: 60%

3. **第3フェーズ**: コンポーネントテストの強化
   - 目標カバレッジ: 70%

## テスト戦略

- **モックの活用**: 外部依存を適切にモック化し、単体テストの信頼性を向上
- **依存性注入**: テスト可能性を高めるため、依存性注入パターンを一貫して適用
- **境界値テスト**: エラーケースや境界条件のテストを強化
- **統合テスト**: 主要なユーザーフローに対する統合テストを追加

リリース前に少なくとも50%のカバレッジを達成することを目指し、その後段階的に70%まで向上させる計画です。

## 次のステップ

1. **userContextモジュールの改善**
   - 依存注入を導入
   ```typescript
   export function createUserContext(storageService: StorageService) {
     // 実装
   }
   ```
   - ストレージサービスを使用するように更新

2. **APIルートの改善**
   - OpenAIサービスを使用するように更新
   - APIクライアントを使用するように更新

3. **ChatWidgetの改善**
   - APIクライアントを使用するように更新
   - 依存注入を導入
   ```typescript
   export function createChatWidget(apiClient: ApiClient) {
     // 実装
   }
   ``` 